<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMC AI - أداة استخلاص البيانات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* (هنا يمكنك وضع كل أكواد CSS التي صممناها سابقًا) */
    </style>
</head>
<body>
    <div id="login-container">
        <h1>مرحباً بك في AMC AI</h1>
        <p>سجل الدخول للمتابعة</p>
        <button id="login-btn"><i class="fab fa-google"></i> تسجيل الدخول باستخدام Google</button>
    </div>

    <div id="dashboard-container" style="display:none;">
        <div id="user-info"></div>
        <button id="logout-btn">تسجيل الخروج</button>
        <hr>
        <h2>رفع ملف جديد</h2>
        <input type="file" id="file-input" accept=".xlsx,.pdf,.png,.jpg,.jpeg,.doc,.docx">
        <button id="upload-btn" disabled>ارفع وابدأ المعالجة</button>
        
        <h2>سجل الطلبات (<button id="refresh-jobs-btn">تحديث</button>)</h2>
        <div id="jobs-table"></div>
    </div>

    <script type="module">
        // استيراد الدوال من شبكة Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, getIdToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // !!== الصق كود Firebase Config الخاص بك هنا ==!!
        const firebaseConfig = {
            // YOUR FIREBASE CONFIG OBJECT HERE
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // --- عناصر الواجهة ---
        const loginContainer = document.getElementById('login-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfoDiv = document.getElementById('user-info');
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const jobsTableDiv = document.getElementById('jobs-table');
        const refreshJobsBtn = document.getElementById('refresh-jobs-btn');
        
        let currentUser = null;

        // --- منطق المصادقة ---
        loginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
        logoutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'block';
                userInfoDiv.innerHTML = `<p>مرحباً، ${user.displayName || user.email}</p>`;
                loadJobs();
            } else {
                currentUser = null;
                loginContainer.style.display = 'block';
                dashboardContainer.style.display = 'none';
            }
        });

        // --- منطق رفع الملفات وسجل الوظائف ---
        fileInput.addEventListener('change', () => {
            uploadBtn.disabled = fileInput.files.length === 0;
        });

        refreshJobsBtn.addEventListener('click', loadJobs);

        uploadBtn.addEventListener('click', async () => {
            if (!fileInput.files[0] || !currentUser) return;
            uploadBtn.disabled = true;
            uploadBtn.innerText = "جاري الرفع...";

            try {
                const token = await getIdToken(currentUser);
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                const response = await fetch('/extract', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'فشل رفع الملف.');
                }
                
                alert('تم إرسال الملف للمعالجة بنجاح! سيظهر في سجل الطلبات قريبًا.');
                fileInput.value = ''; // تفريغ حقل الإدخال
                loadJobs();

            } catch (error) {
                alert(`خطأ: ${error.message}`);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerText = "ارفع وابدأ المعالجة";
            }
        });

        async function loadJobs() {
            if (!currentUser) return;
            jobsTableDiv.innerHTML = '<p>جاري تحميل السجل...</p>';
            try {
                const token = await getIdToken(currentUser);
                const response = await fetch('/jobs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const jobs = await response.json();

                if (jobs.length === 0) {
                    jobsTableDiv.innerHTML = '<p>لا توجد طلبات سابقة.</p>';
                    return;
                }

                let tableHTML = '<table><thead><tr><th>الملف</th><th>الحالة</th><th>النتيجة</th></tr></thead><tbody>';
                jobs.forEach(job => {
                    let result = job.status;
                    if (job.status === 'completed' && job.download_url) {
                        result = `<a href="${job.download_url}" target="_blank">تحميل</a>`;
                    } else if (job.status === 'failed') {
                        result = `<span style="color:red;">فشل: ${job.error || ''}</span>`;
                    }
                    tableHTML += `<tr><td>${job.original_filename}</td><td>${job.status}</td><td>${result}</td></tr>`;
                });
                tableHTML += '</tbody></table>';
                jobsTableDiv.innerHTML = tableHTML;

            } catch (error) {
                jobsTableDiv.innerHTML = '<p style="color:red;">فشل تحميل السجل.</p>';
            }
        }
    </script>
</body>
</html>
